{"version":3,"file":"esm-loader-manager.mjs","sources":["../src/utilities.js","../src/index.js"],"sourcesContent":["import { readdir } from 'node:fs/promises';\nimport { readFile } from 'node:fs/promises';\nimport { isAbsolute } from 'node:path';\nimport { relative as getRelativePath } from 'node:path';\nimport { resolve as resolvePath } from 'node:path';\nimport { fileURLToPath } from 'node:url';\n\nasync function loadURL( url ) {\n\tconst path = fileURLToPath( url );\n\n\treturn readFile( path );\n}\n\nasync function resolveProjectRoot( startDir ) {\n\tconst files = await readdir( startDir );\n\n\tif ( files.includes( 'package.json' ) ) {\n\t\treturn startDir;\n\t}\n\n\tconst dirUp = resolvePath( startDir, '..' );\n\n\t// If directory one level up is the same as the current on,\n\t// we're at / and there's nowhere to go up.\n\tif ( dirUp === startDir ) {\n\t\treturn null;\n\t}\n\n\treturn resolveProjectRoot( dirUp );\n}\n\nconst configFileName = '.esmlmrc';\nconst configFileExtensions = [\n\t'.js',\n\t'.mjs'\n];\n\nasync function resolveConfigFile( startDir, projectRoot ) {\n\tconst files = await readdir( startDir );\n\n\tfor ( const extension of configFileExtensions ) {\n\t\tconst configFileFullName = `${ configFileName }${ extension }`;\n\n\t\tif ( files.includes( configFileFullName ) ) {\n\t\t\tconst resolvedConfigFilePath = resolvePath( startDir, configFileFullName );\n\n\t\t\treturn resolvedConfigFilePath;\n\t\t}\n\t}\n\n\t// Do not go outside of the project root.\n\tif ( startDir === projectRoot ) {\n\t\treturn null;\n\t}\n\n\tconst dirUp = resolvePath( startDir, '..' );\n\n\treturn resolveConfigFile( dirUp );\n}\n\nfunction isInsideDir( dir, pathOrURL ) {\n\tconst filePath = pathOrURL.startsWith( 'file://' ) ? fileURLToPath( pathOrURL ) : pathOrURL;\n\tconst relativePath = getRelativePath( dir, filePath );\n\tconst isNotEmptyPath = relativePath.length > 0;\n\tconst isNotOutsideDir = !relativePath.startsWith( '..' );\n\tconst isNotAbsolutePath = !isAbsolute( relativePath );\n\n\t// https://stackoverflow.com/a/45242825/9025529\n\treturn isNotEmptyPath && isNotOutsideDir && isNotAbsolutePath;\n}\n\nfunction isInsideNodeModules( pathOrURL ) {\n\tconst npmModulesPathRegex = /[/\\\\]node_modules[/\\\\]/gi;\n\n\treturn npmModulesPathRegex.test( pathOrURL );\n}\n\nfunction isBuiltInModule( { url, format } ) {\n\tif ( format ) {\n\t\treturn format === 'builtin';\n\t}\n\n\treturn url.startsWith( 'node:' );\n}\n\nexport { loadURL };\nexport { resolveProjectRoot };\nexport { resolveConfigFile };\nexport { isInsideDir };\nexport { isInsideNodeModules };\nexport { isBuiltInModule };\n","/* eslint-disable no-console */\n\nimport { existsSync as fileExists } from 'node:fs';\nimport { resolve as resolvePath } from 'node:path';\nimport { cwd as processCWD } from 'node:process';\nimport { env as processEnv } from 'node:process';\nimport { pathToFileURL } from 'node:url';\nimport { isBuiltInModule } from './utilities.js';\nimport { isInsideDir } from './utilities.js';\nimport { isInsideNodeModules } from './utilities.js';\nimport { resolveConfigFile } from './utilities.js';\nimport { resolveProjectRoot } from './utilities.js';\nimport { loadURL } from './utilities.js';\n\nconst cwd = processCWD();\nconst resolvedProjectRoot = await resolveProjectRoot( cwd );\n\nif ( !resolvedProjectRoot ) {\n\tconsole.warn( 'ESMLM: The project root was not detected. Falling back to the CWD.' );\n}\n\nconst projectRoot = resolvedProjectRoot || cwd;\nconst loaderFileName = 'ESMLM_CONFIG' in processEnv ? processEnv.ESMLM_CONFIG :\n\tawait resolveConfigFile( cwd, projectRoot );\nconst loaderPath = loaderFileName ? resolvePath( cwd, loaderFileName ) : null;\nlet loaders = [];\n\nif ( loaderPath && fileExists( loaderPath ) ) {\n\tconst loaderURL = pathToFileURL( loaderPath );\n\tconst { default: config } = await import( loaderURL );\n\n\tloaders = config.loaders;\n} else {\n\tconsole.warn( 'ESMLM: The file with loaders\\' definition was not found.' );\n}\n\nasync function resolve( specifier, context, defaultResolve ) {\n\tconst defaultResolvedInfo = await defaultResolve( specifier, context, defaultResolve );\n\tconst { url: moduleURL } = defaultResolvedInfo;\n\n\tif ( shouldIgnoreModule( projectRoot, defaultResolvedInfo ) ) {\n\t\treturn defaultResolvedInfo;\n\t}\n\n\tconst isAnyLoaderForSpecifier = loaders.some( ( { matcher } ) => {\n\t\treturn matcher( moduleURL, context );\n\t} );\n\n\tif ( !isAnyLoaderForSpecifier ) {\n\t\treturn defaultResolvedInfo;\n\t}\n\n\treturn {\n\t\turl: moduleURL,\n\t\ttype: 'module'\n\t};\n}\n\nasync function load( url, context, defaultLoad ) {\n\tconst moduleInfo = { ...context, url };\n\n\tif ( shouldIgnoreModule( projectRoot, moduleInfo ) ) {\n\t\treturn defaultLoad( url, context, defaultLoad );\n\t}\n\n\tconst matchedLoaders = loaders.filter( ( { matcher } ) => {\n\t\treturn matcher( url, context );\n\t} );\n\n\tif ( matchedLoaders.length === 0 ) {\n\t\treturn defaultLoad( url, context, defaultLoad );\n\t}\n\n\tlet source = await loadURL( url );\n\n\tfor ( const { loader } of matchedLoaders ) {\n\t\tsource = await loader( url, source ); // eslint-disable-line no-await-in-loop\n\t}\n\n\treturn {\n\t\tformat: 'module',\n\t\tshortCircuit: true,\n\t\tsource\n\t};\n}\n\nfunction shouldIgnoreModule( projectRoot, moduleInfo ) {\n\tconst moduleURL = moduleInfo.url;\n\n\treturn isBuiltInModule( moduleInfo ) || isInsideNodeModules( moduleURL ) || !isInsideDir( projectRoot, moduleURL );\n}\n\nexport { resolve };\nexport { load };\n"],"names":["configFileName","cwd","async","resolveProjectRoot","startDir","dirUp","resolve$1","resolvedProjectRoot","console","projectRoot","env","ESMLM_CONFIG","files","resolveConfigFile","extension","configFileFullName","includes","loaderFileName","loaders","existsSync","loaderPath","fileExists","default","config","warn","resolve","specifier","context","defaultResolve","defaultResolvedInfo","url","moduleURL","shouldIgnoreModule","some","matcher","type","load","defaultLoad","moduleInfo","matchedLoaders","filter","length","source","loadURL","readFile","loader","format","shortCircuit","startsWith","isBuiltInModule","pathOrURL","test","dir","filePath","isInsideDir","fileURLToPath","relative","relativePath","getRelativePath","isNotEmptyPath","isNotOutsideDir","isNotAbsolutePath"],"mappings":";wQA6BA,MAEMA,EAAiB,CAAA,MAAU,oBCjB3BC,QDHNC,eAAAC,EAAAC,GAGC,UADcD,EAAAA,aACA,uBAEJC,EAEV,MAAAC,EAAAC,EAAAF,EAAA,MAKA,OAAAC,IAAAD,EACU,KAEVD,EAAAE,GCZuBF,CAAAF,GACxBM,GAEKC,mFAEL,MAAAC,EAAAF,GAAAN,EAEMQ,EAAiC,iBAAAC,EAAOA,EAAAC,mBDW9CT,mBAEOO,GAGP,MAAAG,QAAgCC,EAAAA,GAC/B,IAAA,MAAWC,OAA4B,CAEjC,MAAAC,aAA0CD,IAC/C,GAAAF,EAAwBI,SAAAD,GAAuB,CAG9C,OADoBA,EAAuBX,EAAAW,EAG3C,CACD,CAGD,OAAAX,IAAAK,EACKL,OAELE,EAAAF,EAAA,OChC6CS,CAAAZ,EAAAQ,GACxCQ,IAAiBX,IAA0CK,QAEjE,IAAAO,EAAgB,GAChB,GAAIA,GAAYC,EAAAC,GAAA,CAEhB,QAAmBC,EAAYD,IAExBE,QAAAC,gBAAWA,GAEjBL,EAAUK,EAAOL,OAClB,MACCV,QAAQgB,KAAM,2DAGftB,eAAeuB,EAASC,EAAWC,EAASC,GAC3C,MAAMC,QAA4BD,EAAgBF,EAAWC,EAASC,IAC9DE,IAAKC,GAAcF,EAE3B,GAAKG,EAAoBvB,EAAaoB,GACrC,OAAOA,EAOR,OAJgCX,EAAQe,MAAM,EAAIC,aAC1CA,EAASH,EAAWJ,KAOrB,CACNG,IAAKC,EACLI,KAAM,UALCN,CAOT,CAEA3B,eAAekC,EAAMN,EAAKH,EAASU,GAClC,MAAMC,EAAa,IAAKX,EAASG,OAEjC,GAAKE,EAAoBvB,EAAa6B,GACrC,OAAOD,EAAaP,EAAKH,EAASU,GAGnC,MAAME,EAAiBrB,EAAQsB,QAAQ,EAAIN,aACnCA,EAASJ,EAAKH,KAGtB,GAA+B,IAA1BY,EAAeE,OACnB,OAAOJ,EAAaP,EAAKH,EAASU,GAGnC,IAAIK,0BDlEUC,MAAAA,EAAAA,EAAeb,GAC7B,OAAUc,KCiESD,CAASb,GAE5B,IAAM,MAAMe,OAAEA,KAAYN,EACzBG,QAAeG,EAAQf,EAAKY,GAG7B,MAAO,CACNI,OAAQ,SACRC,cAAc,EACdL,SAEF,CAEA,SAASV,EAAoBvB,EAAa6B,GACzC,MAAMP,EAAYO,EAAWR,IAE7B,ODdD,UAAAA,IAEAA,EAAAgB,OAA4BhB,IAAgB,OAAAgB,EAC7B,cAEdhB,EAAAkB,WAAA,QAEA,CCOOC,CAAiBX,IDlBKY,2BACDC,KCiBiCpB,KD/B9D,SAAAqB,EAAAF,GAEA,MAAAG,EAAoBC,aAAmB,WAAAC,EAAAL,GAAAA,EAChCG,EAAoBG,OACpBC,EAAeC,EAA+BjB,OAAC,EAC/CkB,GAAiBF,EAAmBT,WAAI,MACxCY,GAAmBH,EAAaT,GAGtC,OAAAW,GAAAC,GAAAC,CACA,CCqB6EP,CAAa7C,EAAasB,EACxG"}